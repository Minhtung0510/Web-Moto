@model MotoBikeStore.Models.Order
@{ Layout="~/Views/Shared/_Layout.cshtml"; ViewData["Title"]="Chi tiết đơn hàng #" + Model.Id; }

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="fas fa-file-invoice me-2"></i>Chi tiết đơn hàng #@Model.Id</h3>
    <a href="/Admin/Orders" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-2"></i>Quay lại
    </a>
  </div>

  @if(TempData["SuccessMessage"] != null)
  {
    <div class="alert alert-success alert-dismissible">
      @TempData["SuccessMessage"]
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  }

  <div class="row g-4">
    <!-- Order Info -->
    <div class="col-md-8">
      <!-- Customer Info -->
      <div class="card mb-3">
        <div class="card-header bg-white">
          <h5 class="mb-0">Thông tin khách hàng</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p><strong>Họ tên:</strong> @Model.CustomerName</p>
              <p><strong>Số điện thoại:</strong> @Model.Phone</p>
              <p><strong>Email:</strong> @(Model.Email ?? "N/A")</p>
            </div>
            <div class="col-md-6">
              <p><strong>Địa chỉ:</strong> @Model.Address</p>
              @if(!string.IsNullOrEmpty(Model.Notes))
              {
                <p><strong>Ghi chú:</strong> @Model.Notes</p>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Order Items -->
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">Sản phẩm đã đặt</h5>
        </div>
        <div class="card-body p-0">
          <table class="table mb-0">
            <thead class="table-light">
              <tr>
                <th>Sản phẩm</th>
                <th class="text-center">SL</th>
                <th class="text-end">Đơn giá</th>
                <th class="text-end">Thành tiền</th>
              </tr>
            </thead>
            <tbody>
              @foreach(var item in Model.Details)
              {
                <tr>
                  <td>
                    <div class="d-flex align-items-center">
                      <img src="@item.Product.ImageUrl" style="width:50px;height:50px;object-fit:contain" class="me-3" />
                      <div>
                        <strong>@item.Product.Name</strong><br>
                        <small class="text-muted">@item.Product.Brand</small>
                      </div>
                    </div>
                  </td>
                  <td class="text-center">@item.Quantity</td>
                  <td class="text-end">@item.UnitPrice.ToString("N0")₫</td>
                  <td class="text-end"><strong>@((item.Quantity * item.UnitPrice).ToString("N0"))₫</strong></td>
                </tr>
              }
            </tbody>
            <tfoot class="table-light">
              <tr>
                <td colspan="3" class="text-end"><strong>Tạm tính:</strong></td>
                <td class="text-end"><strong>@Model.Subtotal.ToString("N0")₫</strong></td>
              </tr>
              <tr>
                <td colspan="3" class="text-end"><strong>Phí vận chuyển:</strong></td>
                <td class="text-end"><strong>@Model.ShippingFee.ToString("N0")₫</strong></td>
              </tr>
              @if(Model.DiscountAmount > 0)
              {
                <tr class="text-success">
                  <td colspan="3" class="text-end">
                    <strong>Giảm giá:</strong>
                    @if(Model.Coupon != null)
                    {
                      <span class="badge bg-success ms-2">@Model.Coupon.Code</span>
                    }
                  </td>
                  <td class="text-end"><strong>-@Model.DiscountAmount.ToString("N0")₫</strong></td>
                </tr>
              }
              <tr>
                <td colspan="3" class="text-end"><h5 class="mb-0">Tổng cộng:</h5></td>
                <td class="text-end"><h5 class="mb-0 text-danger">@Model.Total.ToString("N0")₫</h5></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Order Status & Actions -->
    <div class="col-md-4">
      <!-- Current Status -->
      <div class="card mb-3">
        <div class="card-header bg-white">
          <h5 class="mb-0">Trạng thái đơn hàng</h5>
        </div>
        <div class="card-body text-center">
          <span class="badge bg-@(Model.Status switch {
            "Pending" => "warning",
            "Confirmed" => "info",
            "Processing" => "primary",
            "Shipping" => "primary",
            "Delivered" => "success",
            "Cancelled" => "danger",
            _ => "secondary"
          }) fs-4">
            @(Model.Status switch {
              "Pending" => "Chờ xác nhận",
              "Confirmed" => "Đã xác nhận",
              "Processing" => "Đang xử lý",
              "Shipping" => "Đang giao hàng",
              "Delivered" => "Đã giao hàng",
              "Cancelled" => "Đã hủy",
              _ => Model.Status
            })
          </span>
          
          <hr>
          
          <p class="mb-1"><strong>Ngày đặt:</strong></p>
          <p>@Model.OrderDate.ToString("dd/MM/yyyy HH:mm")</p>
          
          @if(Model.ShippedDate.HasValue)
          {
            <p class="mb-1"><strong>Ngày giao:</strong></p>
            <p>@Model.ShippedDate.Value.ToString("dd/MM/yyyy")</p>
          }
          
          @if(Model.DeliveredDate.HasValue)
          {
            <p class="mb-1"><strong>Ngày nhận:</strong></p>
            <p>@Model.DeliveredDate.Value.ToString("dd/MM/yyyy")</p>
          }
          
          @if(!string.IsNullOrEmpty(Model.TrackingNumber))
          {
            <p class="mb-1"><strong>Mã vận đơn:</strong></p>
            <p><code>@Model.TrackingNumber</code></p>
          }
        </div>
      </div>

      <!-- Update Status -->
      <div class="card">
        <div class="card-header bg-white">
          <h5 class="mb-0">Cập nhật trạng thái</h5>
        </div>
        <div class="card-body">
          <form method="post" action="/Admin/UpdateOrderStatus">
            <input type="hidden" name="id" value="@Model.Id" />
            
            <div class="mb-3">
              <label class="form-label">Trạng thái mới</label>
              <select name="status" class="form-select" required>
                <option value="Pending" @(Model.Status == "Pending" ? "selected" : "")>Chờ xác nhận</option>
                <option value="Confirmed" @(Model.Status == "Confirmed" ? "selected" : "")>Đã xác nhận</option>
                <option value="Processing" @(Model.Status == "Processing" ? "selected" : "")>Đang xử lý</option>
                <option value="Shipping" @(Model.Status == "Shipping" ? "selected" : "")>Đang giao hàng</option>
                <option value="Delivered" @(Model.Status == "Delivered" ? "selected" : "")>Đã giao hàng</option>
                <option value="Cancelled" @(Model.Status == "Cancelled" ? "selected" : "")>Đã hủy</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Mã vận đơn (nếu có)</label>
              <input type="text" name="trackingNumber" class="form-control" 
                     value="@Model.TrackingNumber" placeholder="VD: VNP123456789" />
            </div>
            
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-save me-2"></i>Cập nhật
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>